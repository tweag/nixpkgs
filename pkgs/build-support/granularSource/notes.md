# Granular build-time sources

## Use cases

- Build-time source filtering without duplicating files in the Nix store
- fetchIndividualFromGitHub?, useful for e.g. nerdfonts
- Patching can be very cheap, essentially [lazy trees](https://github.com/NixOS/nix/pull/6530) but at build time
- Patch a build without having to rebuild everything. `pkgs.individualFiles.patch`?
- Overriding with just `src = some/local/source` should not do a rebuild if the version matches, but also only minimal rebuilds if you change a file!

## `pkgs.granularSource.hashDerivationFiles`

**Type:** `{ src :: Derivation, hashType :: String } -> Derivation`

Precomputes hashes for all files in a derivation.
The resulting file is suitable to be passed to `annotateHashes`, either as a derivation (which then leads to IFD, disallowed in nixpkgs), or as a file path when copied locally.

The resulting JSON file's format is as follows:

```json
{
  "someDir/someFile.nix": "sha256-5rAeSHaY8qfcdxHvb9XWZCYX35hYBssalFbZiYjoJV0=",
  "someFile.nix": "sha256-1rCVS1wK2D9lL22rbmdE6Wg2PwXRZxgFw8CVqnw3txM=%"
}
```

The object keys are sorted alphabetically, the hashes use the SRI hash format, symlinks are ignored, this operation is done at build time.

## `pkgs.granularSource.hashPathFiles`

**Type:** `{ src :: Path, hashType :: String } -> Path`

Like `pkgs.granularSource.hashDerivationFiles`, but all done at evaluation time.
TODO: Actually not needed, since we can just use `builtins.path` to generate individual store paths for files if we have a non-derivation path. Though is it still useful somehow?

## `pkgs.granularSource.annotateHashes`

**Type:** `{ src :: Derivation, hashFile :: Path } -> Derivation // { passthru.granularSource.{files,generate,validate} }`

Decodes a `hashFile` generated by `hashDerivationFiles` and creates individual fixed-output derivations for each file, returning them as the `granularSource.files.<subpath>` passthru.
If the hash doesn't match the files, an error is thrown at build time.
Additionally it adds a `granularSource.generate` passthru, which is a derivation containing a binary which when ran, computes the hashes of `src` using `hashDerivationFiles`, then copies the result to `hashes.json`.
This can be used to initially generate `hashes.json` or update it when the `src` changes.
Additionally a `granularSource.validate` passthru is added, which is a derivation which when built will validate that the hashes in `hashFile` are up-to-date, which can be used to check whether the `generate` script needs to be rerun.

In nixpkgs this can be used for builders that can benefit from file-level build granularity, such as `c2nix.buildCPP` like this:

```
c2nix.buildCPP {
  src = granularSource.annotateHashes {
    src = fetchFromGitHub { ... };
    hashFile = ./hashes.json;
  };
}
```











